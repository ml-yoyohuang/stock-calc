<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å°è‚¡æŠ•è³‡è¦ç•«å·¥å…· - åŠ ä¸Šåˆ†äº«åœ–ç‰‡è©¦åšç‰ˆ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        /* éš±è—çš„å ±è¡¨æ¨£æ¿ï¼Œä¸æœƒé¡¯ç¤ºåœ¨ç•«é¢ä¸Šï¼Œä½†æœƒç”¨æ–¼æˆªåœ– */
        #report-template {
            position: absolute;
            left: -9999px; /* ç§»åˆ°è¢å¹•å¤– */
            top: -9999px;
            width: 450px; /* å›ºå®šå ±è¡¨å¯¬åº¦ï¼Œæ–¹ä¾¿åˆ†äº« */
            padding: 20px;
            background-color: #0097ba20;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            box-sizing: border-box; /* ç¢ºä¿ padding ä¸æœƒå½±éŸ¿å¯¬åº¦ */

            /* å°‡ SVG è½‰ç‚ºç·¨ç¢¼å¾Œçš„ URL */
            /* å­˜è‚¡å–µ */
            /* background-image: url("data:image/svg+xml,%3Csvg width='120' height='120' opacity='0.15' viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cg transform='translate(12, 12) scale(1)'%3E%3Cpath d='M10,25 L25,5 L40,22' fill='none' stroke='%234a4a4a' stroke-width='5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M60,25 L45,5 L30,22' fill='none' stroke='%234a4a4a' stroke-width='5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cellipse cx='35' cy='45' rx='35' ry='30' fill='white' stroke='%234a4a4a' stroke-width='5'/%3E%3Cpath d='M18,45 Q23,40 28,45' fill='none' stroke='%234a4a4a' stroke-width='4' stroke-linecap='round'/%3E%3Cpath d='M42,45 Q47,40 52,45' fill='none' stroke='%234a4a4a' stroke-width='4' stroke-linecap='round'/%3E%3Cpath d='M30,55 Q35,60 40,55' fill='none' stroke='%234a4a4a' stroke-width='3' stroke-linecap='round'/%3E%3C/g%3E%3Cg transform='translate(135, 35)'%3E%3Ccircle cx='15' cy='15' r='18' fill='%23fff9c4' stroke='%23fbc02d' stroke-width='4'/%3E%3Ctext x='15' y='22' font-family='Arial' font-size='20' font-weight='bold' text-anchor='middle' fill='%23fbc02d'%3E$%3C/text%3E%3C/g%3E%3Cg transform='translate(25, 135)'%3E%3Cpath d='M10,25 L20,15 L30,20 L45,5' fill='none' stroke='%23ef5350' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M35,5 H45 V15' fill='none' stroke='%23ef5350' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/g%3E%3Cg transform='translate(112, 112) scale(1)'%3E%3Cpath d='M10,25 L25,5 L40,22' fill='none' stroke='%234a4a4a' stroke-width='5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cpath d='M60,25 L45,5 L30,22' fill='none' stroke='%234a4a4a' stroke-width='5' stroke-linecap='round' stroke-linejoin='round'/%3E%3Cellipse cx='35' cy='45' rx='35' ry='30' fill='white' stroke='%234a4a4a' stroke-width='5'/%3E%3Cpath d='M18,45 Q23,40 28,45' fill='none' stroke='%234a4a4a' stroke-width='4' stroke-linecap='round'/%3E%3Cpath d='M42,45 Q47,40 52,45' fill='none' stroke='%234a4a4a' stroke-width='4' stroke-linecap='round'/%3E%3Cpath d='M30,55 Q35,60 40,55' fill='none' stroke='%234a4a4a' stroke-width='3' stroke-linecap='round'/%3E%3C/g%3E%3C/svg%3E"); */
            /* å­˜è‚¡æ±ª */
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='120' height='120' viewBox='0 0 120 120' opacity='0.4'%3E%3Cg transform='translate(15,15)'%3E%3Cellipse fill='white' cx='15' cy='21' rx='18' ry='16.8'/%3E%3Cpath fill='none' stroke='%23CCCCCC' d='M0,9c-4,4-4,9,0,15'/%3E%3Cpath fill='none' stroke='%23CCCCCC' d='M30,9c4,4,4,9,0,15'/%3E%3Ccircle cx='9' cy='19.2' r='1.8'/%3E%3Ccircle cx='21' cy='19.2' r='1.8'/%3E%3Cellipse cx='15' cy='24' rx='3' ry='1.8'/%3E%3C/g%3E%3Cg transform='translate(90,30)'%3E%3Ccircle fill='%23FFF9C4' stroke='%23FBC02D' stroke-width='2.4' cx='0' cy='0' r='10.8'/%3E%3Ctext x='0' y='4' font-family='Arial' font-weight='bold' font-size='12' text-anchor='middle' fill='%23FBC02D'%3E$%3C/text%3E%3C/g%3E%3Cg transform='translate(21,96)'%3E%3Cpath fill='none' stroke='%23EF5350' stroke-width='3.6' stroke-linecap='round' stroke-linejoin='round' d='M0,0 l6,-6 l6,3 l9,-9'/%3E%3Cpath fill='none' stroke='%23EF5350' stroke-width='3.6' stroke-linecap='round' stroke-linejoin='round' d='M15,-12 h6 v6'/%3E%3C/g%3E%3Cg transform='translate(90,96)'%3E%3Cellipse fill='white' cx='0' cy='0' rx='18' ry='16.8'/%3E%3Cpath fill='none' stroke='%23CCCCCC' d='M-15,-12 c-4,4,-4,9,0,15'/%3E%3Cpath fill='none' stroke='%23CCCCCC' d='M15,-12 c4,4,4,9,0,15'/%3E%3Ccircle cx='-6' cy='-1.8' r='1.8'/%3E%3Ccircle cx='6' cy='-1.8' r='1.8'/%3E%3Cellipse cx='0' cy='3' rx='3' ry='1.8'/%3E%3C/g%3E%3C/svg%3E");
            background-position: top 0 left 0;
            background-repeat: repeat;
            background-size: 90px 90px; /* èª¿æ•´é€™å€‹æ•¸å€¼å¯ä»¥æ”¹è®Šåœ–æ¡ˆçš„å¤§å° */
            
        }
        #report-template h2 {
            font-size: 24px;
            font-weight: bold;
            color: #3b82f6; /* è—è‰² */
            margin-bottom: 15px;
            text-align: center;
        }
        #report-template .report-section {
            background-color: #e0f2fe; /* æ·ºè—è‰² */
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 1px solid #bfdbfe; /* æ·ºè—é‚Šæ¡† */
        }
        #report-template .report-section-dark {
            background-color: #1f2937; /* æ·±ç° */
            color: #fff;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
        }
        #report-template .report-label {
            font-size: 12px;
            color: #60a5fa; /* è¼ƒæ·±çš„è— */
            margin-bottom: 5px;
            font-weight: bold;
        }
        #report-template .report-label-dark {
            font-size: 12px;
            color: #9ca3af; /* æ·ºç° */
            margin-bottom: 5px;
            font-weight: bold;
        }
        #report-template .report-value {
            font-size: 20px;
            font-weight: bold;
            color: #1d4ed8; /* æ›´æ·±çš„è— */
        }
        #report-template .report-value-light {
            font-size: 20px;
            font-weight: bold;
            color: #fff;
        }
        #report-template .report-footer {
            text-align: center;
            font-size: 10px;
            color: #9ca3af;
            margin-top: 20px;
        }
        /* Chart.js ç›¸é—œè¨­å®š */
        #report-template #reportChart {
            background-color: #fff; /* åœ–è¡¨èƒŒæ™¯è‰² */
            border-radius: 8px;
            padding: 10px;
        }
    </style>
</head>
<body class="bg-slate-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto px-4 py-12">

        <div v-if="currentStep === 1" class="max-w-2xl mx-auto bg-white rounded-3xl shadow-xl p-8 border border-slate-200">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">é–‹å§‹æŠ•è³‡è¦ç•«</h1>
                <p class="text-slate-500 mt-2">è«‹é¸å–æˆ–æ‰‹å‹•è¼¸å…¥è‚¡ç¥¨ä»£è™Ÿï¼ˆå·²è‡ªå‹•ç”±å°åˆ°å¤§æ’åºï¼‰</p>
            </div>
            
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-3">ç†±é–€æ¨è–¦</label>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="id in sortedHotList" :key="id" 
                                @click="toggleStock(id)"
                                :class="['px-4 py-2 rounded-xl border-2 font-bold transition-all', 
                                selectedIds.includes(id) ? 'bg-blue-600 border-blue-600 text-white shadow-lg' : 'bg-white border-slate-100 text-slate-500 hover:border-blue-300']">
                            {{ id }}
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-3">è‡ªå®šç¾©åŠ å…¥</label>
                    <div class="flex gap-2">
                        <input type="text" inputmode="decimal" v-model="customInput" placeholder="ä¾‹å¦‚: 00713" @keyup.enter="addCustomStock"
                               class="text-base flex-1 border-2 border-slate-100 rounded-xl px-4 py-2 outline-none focus:border-blue-500 font-mono">
                        <button @click="addCustomStock" class="bg-slate-800 text-white px-6 py-2 rounded-xl font-bold hover:bg-slate-700 transition-colors">åŠ å…¥</button>
                    </div>
                </div>

                <div v-if="selectedIds.length > 0" class="pt-6 border-t border-slate-100">
                    <label class="block text-xs font-bold text-slate-400 uppercase tracking-widest mb-3">æ‚¨çš„æŠ•è³‡çµ„åˆæ¸…å–®</label>
                    <div class="flex flex-wrap gap-2">
                        <div v-for="id in sortedSelectedIds" :key="id" class="flex items-center gap-2 bg-blue-50 px-3 py-1.5 rounded-full text-sm font-bold text-blue-600 border border-blue-100">
                            {{ id }}
                            <button @click="toggleStock(id)" class="text-blue-300 hover:text-red-500 font-black">Ã—</button>
                        </div>
                    </div>
                </div>

                <button @click="goToDashboard" :disabled="selectedIds.length === 0"
                        class="w-full py-4 rounded-2xl font-black text-lg shadow-xl transition-all"
                        :class="selectedIds.length > 0 ? 'bg-blue-600 text-white hover:bg-blue-700' : 'bg-slate-200 text-slate-400 cursor-not-allowed'">
                    ä¸‹ä¸€æ­¥ï¼šé€²å…¥è©¦ç®—å„€è¡¨æ¿
                </button>
            </div>
        </div>

        <div v-if="currentStep === 2">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                <div class="flex items-center gap-4">
                    <button @click="currentStep = 1" class="bg-white border border-slate-200 p-2 rounded-xl hover:bg-slate-50 shadow-sm">â¬… è¿”å›</button>
                    <div>
                        <h1 class="text-3xl font-black text-slate-800">æŠ•è³‡è¦ç•«å„€è¡¨æ¿</h1>
                        <p class="text-slate-500 text-sm">æ•¸æ“šæ¯å°æ™‚è‡ªå‹•å¿«å–ï¼Œä¿è­· API é¡åº¦</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span v-if="loading" class="text-xs bg-amber-100 text-amber-600 px-3 py-1 rounded-full animate-pulse font-bold">åŒæ­¥ API ä¸­...</span>
                    <button @click="generateReportImage" class="bg-blue-500 text-white text-sm px-4 py-2 rounded-xl flex items-center gap-2 hover:bg-blue-600 transition-colors shadow-sm">
                        ğŸ“¸ ä¸‹è¼‰å ±è¡¨
                    </button>
                    <button @click="resetData" class="text-xs text-slate-400 hover:text-red-500 underline">é‡ç½®æ‰€æœ‰è³‡æ–™</button>
                </div>
            </div>

            <div class="grid grid-cols-12 gap-6">
                <div class="col-span-12 xl:col-span-8">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-auto text-sm">
                        <table class="w-full text-left border-collapse min-w-[600px]">
                            <thead>
                                <tr class="bg-slate-800 text-white text-[10px] uppercase tracking-wider">
                                    <th class="p-4">è‚¡ç¥¨ä»£è™Ÿ/ç¾åƒ¹/<br>è¿‘ä¸€å¹´è‚¡åƒ¹æ¼²è·Œå¹…&é…æ¯</th>
                                    <th class="p-4 text-center">åº«å­˜(å¼µ)</th>
                                    <th class="p-4 text-center">æ¯æœˆæ‰£æ¬¾(åƒ)</th>
                                    <th class="p-4 text-center">æ¯æœˆæ¬¡æ•¸</th>
                                    <th class="p-4 text-center">é ä¼°å ±é…¬ %</th>
                                    <th class="p-4 text-right">æœˆæŠ•å°è¨ˆ</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="stock in sortedStocks" :key="stock.id" class="hover:bg-slate-50">
                                    
                                    <td class="p-4">
                                        <div class="font-bold text-slate-700 leading-tight text-base">{{ stock.id }}</div>
                                        
                                        <div class="flex flex-col gap-1 mt-1">
                                            <span class="text-[11px] text-blue-500 font-mono font-bold">
                                                {{ stock.price ? `$${stock.price}` : 'è¼‰å…¥ä¸­...' }}
                                            </span>
                                            
                                            <div class="flex flex-wrap gap-1">
                                                <span v-if="stock.yearlyReturn" 
                                                    :class="['text-[9px] font-black px-1.5 py-0.5 rounded leading-none', 
                                                            stock.yearlyReturn >= 0 ? 'text-red-600 bg-red-50' : 'text-emerald-600 bg-emerald-50']">
                                                    {{ stock.yearlyReturn >= 0 ? 'â–²' : 'â–¼' }}{{ Math.abs(stock.yearlyReturn) }}%
                                                </span>

                                                <span v-if="stock.yieldRate" 
                                                    class="text-[9px] font-black px-1.5 py-0.5 rounded leading-none text-indigo-600 bg-indigo-50">
                                                    æ¯ {{ stock.yieldRate }}%
                                                </span>
                                            </div>
                                        </div>
                                    </td>
                                    <td class="p-4 text-center"><input type="number" inputmode="decimal" v-model.number="stock.holdings" class="text-base w-16 border rounded text-center py-1 bg-blue-50/50 outline-none focus:border-blue-400"></td>
                                    <td class="p-4 text-center"><input type="number" inputmode="decimal" v-model.number="stock.amount" class="text-base w-14 border rounded text-center py-1 outline-none"></td>
                                    <td class="p-4 text-center"><input type="number" inputmode="decimal" v-model.number="stock.frequency" class="text-base w-10 border rounded text-center py-1 outline-none"></td>
                                    <td class="p-4 text-center"><input type="number" inputmode="decimal" v-model.number="stock.rate" step="0.5" class="text-base w-12 text-center text-emerald-600 font-bold bg-transparent">%</td>
                                    <td class="p-4 text-right font-mono font-bold text-slate-600 italic">{{ (stock.amount * stock.frequency).toLocaleString() }}k</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="col-span-12 xl:col-span-4 space-y-6">
                    <div class="bg-slate-800 p-6 rounded-3xl text-white shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">é ä¼° {{ targetYears }} å¹´å¾Œç¸½åƒ¹å€¼</p>
                            <span class="text-[10px] bg-blue-600 px-2 py-1 rounded font-bold">{{ targetYears }}Y</span>
                        </div>
                        <h2 class="text-4xl font-black tracking-tight text-blue-400 mb-6">
                            NT$ {{ (calculateFutureValue(targetYears)/10000).toFixed(0) }} <span class="text-lg text-white">è¬</span>
                        </h2>
                        <div class="grid grid-cols-2 gap-4 mb-6 pt-6 border-t border-slate-700">
                            <div>
                                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">ç›®å‰åº«å­˜å¸‚å€¼</p>
                                <p class="text-lg font-bold text-white">{{ (currentInventoryValue/10000).toFixed(1) }} <span class="text-xs">è¬</span></p>
                            </div>
                            <div>
                                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">æœˆæŠ•å…¥ç¸½é¡</p>
                                <p class="text-lg font-bold text-white">{{ (totalMonthlyAmount/1000).toFixed(1) }} <span class="text-xs">K</span></p>
                            </div>
                        </div>
                        <input type="range" v-model.number="targetYears" min="1" max="40" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-wider">è³‡ç”¢å¢é•·æ›²ç·š</h3>
                        <div class="h-[250px]"><canvas id="growthChart"></canvas></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-wider">å¹´åº¦é è¨ˆé ˜æ¯æœˆä»½ (è¿‘12å€‹æœˆåˆ†æ)</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <div v-for="m in 12" :key="m" 
                                 :class="['p-3 rounded-xl border transition-all min-h-[85px]', 
                                 getDividendStocks(m).length > 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 opacity-40']">
                                <div class="text-[10px] font-black text-slate-400 mb-1 border-b pb-1 flex justify-between items-center">
                                    <span>{{ m }}æœˆ</span>
                                    <span v-if="getMonthlyDividendAmount(m) > 0" class="text-emerald-700 font-bold bg-emerald-200/50 px-1 rounded">
                                        ${{ getMonthlyDividendAmount(m).toLocaleString() }}
                                    </span>
                                </div>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    <span v-for="code in getDividendStocks(m)" :key="code" class="text-[9px] font-bold bg-emerald-600 text-white px-1 rounded">
                                        {{ code }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="report-template">
        <h2>ğŸ’° æ‚¨çš„æŠ•è³‡è¦ç•«å ±å‘Š ğŸ“ˆ</h2>
        <div class="report-section">
            <div class="report-label">ç›®å‰åº«å­˜å¸‚å€¼</div>
            <div class="report-value" id="rep-current-val">NT$ 0 è¬</div>
        </div>
        <div class="report-section">
            <div class="report-label">æ¯æœˆæŠ•å…¥ç¸½é¡</div>
            <div class="report-value" id="rep-monthly-val">NT$ 0 K</div>
        </div>
        <div class="report-section-dark">
            <div class="report-label-dark" id="rep-target-label">é ä¼° 20 å¹´å¾Œç¸½åƒ¹å€¼</div>
            <div class="report-value-light" id="rep-future-val">NT$ 0 è¬ ğŸ‰</div>
        </div>
        <div class="report-section" style="padding: 10px;">
            <div class="report-label" style="margin-bottom: 20px;">è³‡ç”¢å¢é•·æ›²ç·š</div>
            <canvas id="reportChart" width="390" height="200"></canvas>
        </div>
        <div class="report-footer">
            å ±å‘Šç”Ÿæˆæ™‚é–“: <span id="rep-time"></span> | è³‡æ–™ä¾†æº: FinMind API
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        const apiCache = {}; // å…¨åŸŸ API å¿«å–å®¹å™¨

        createApp({
            setup() {
                const currentStep = ref(1);
                // hotList çš„æ’åºå·²åœ¨ sortedHotList ä¸­è™•ç†
                const hotList = ref(['0050', '0056', '006208', '00878', '2330']); 
                const selectedIds = ref([]);
                const customInput = ref("");
                const stocks = ref([]);
                const loading = ref(false);
                const targetYears = ref(20);
                const currentDateTime = ref(''); // ç”¨æ–¼å ±è¡¨æ™‚é–“
                let chart = null; // ä¸»è¦å„€è¡¨æ¿åœ–è¡¨
                let reportChartInstance = null; // å ±è¡¨å°ˆç”¨åœ–è¡¨å¯¦ä¾‹
                let debounceTimer = null;

                const masterData = {
                    '0050': { months: [1, 7], rate: 8.5 },
                    '0056': { months: [1, 4, 7, 10], rate: 6.5 },
                    '00878': { months: [2, 5, 8, 11], rate: 6.0 },
                    '006208': { months: [1, 7], rate: 8.5 },
                    '2330': { months: [3, 6, 9, 12], rate: 12.0 },
                    '00919': { months: [3, 6, 9, 12], rate: 10.0 }, // é è¨­å€¼ï¼Œå¯èƒ½éœ€è¦å¯¦éš›æŠ“å–å¾Œèª¿æ•´
                    '00929': { months: [1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12], rate: 8.0 }, // é è¨­å€¼ï¼Œå¯èƒ½éœ€è¦å¯¦éš›æŠ“å–å¾Œèª¿æ•´
                    'default': { months: [1, 4, 7, 10], rate: 7.0 }
                };

                // --- æ’åºè¨ˆç®—å±¬æ€§ ---
                const sortedHotList = computed(() => [...hotList.value].sort());
                const sortedSelectedIds = computed(() => {
                    // ç§»é™¤ numeric: trueï¼Œå›æ­¸ç´”å­—ä¸²å­—å…¸åºæ¯”è¼ƒ
                    return [...selectedIds.value].sort();
                });
                
                const sortedStocks = computed(() => {
                    // åŒæ¨£å›æ­¸ç´”å­—ä¸²æ¯”è¼ƒ
                    return [...stocks.value].sort((a, b) => a.id.localeCompare(b.id));
                });


                // --- é¸å–èˆ‡åŠ å…¥é‚è¼¯ ---
                const toggleStock = (id) => {
                    const index = selectedIds.value.indexOf(id);
                    if (index > -1) {
                        selectedIds.value.splice(index, 1);
                    } else {
                        selectedIds.value.push(id);
                    }
                };

                const addCustomStock = () => {
                    const id = customInput.value.trim();
                    if (id && !selectedIds.value.includes(id)) {
                        selectedIds.value.push(id);
                    }
                    customInput.value = "";
                };

                // --- æ ¸å¿ƒé‹ç®—é‚è¼¯ (forEach ç‰ˆ) ---
                const currentInventoryValue = computed(() => {
                    let total = 0;
                    stocks.value.forEach(s => { total += (s.holdings || 0) * 1000 * (s.price || 0); });
                    return total;
                });

                const totalMonthlyAmount = computed(() => {
                    let total = 0;
                    stocks.value.forEach(s => { total += (s.amount || 0) * (s.frequency || 0) * 1000; });
                    return total;
                });

                const calculateFutureValue = (years) => {
                    let grandTotal = 0;
                    stocks.value.forEach(s => {
                        const startVal = (s.holdings || 0) * 1000 * (s.price || 0);
                        const r_annual = (s.rate || 0) / 100;
                        const futureInventory = startVal * Math.pow(1 + r_annual, years);
                        const p = (s.amount || 0) * (s.frequency || 0) * 1000;
                        let futureSIP = 0;
                        if (p > 0) {
                            const r_monthly = r_annual / 12;
                            const n_months = years * 12;
                            futureSIP = p * (Math.pow(1 + r_monthly, n_months) - 1) / r_monthly;
                        }
                        grandTotal += (futureInventory + futureSIP);
                    });
                    return Math.round(grandTotal);
                };

                const getMonthlyDividendAmount = (month) => {
                    let total = 0;
                    stocks.value.forEach(s => {
                        if (s.months.includes(month) && s.avgDividend > 0) {
                            const divPerTime = s.avgDividend / s.months.length;
                            const fromHoldings = (s.holdings || 0) * 1000 * divPerTime;
                            const monthlyShares = ((s.amount || 0) * 1000) / (s.price || 150);
                            const fromSIP = (monthlyShares * 6) * divPerTime; // ç²—ä¼°åŠå¹´å¹³å‡æŒæœ‰é‡
                            total += (fromHoldings + fromSIP);
                        }
                    });
                    return Math.round(total);
                };

                // --- API æŠ“å–èˆ‡å¿«å– ---
                const fetchPricesAndDividends = async (force = false) => {
                    if (loading.value && !force) return;
                    loading.value = true;
                    try {
                        const now = new Date();
                        const oneYearAgo = new Date();
                        oneYearAgo.setFullYear(now.getFullYear() - 1);

                        const tasks = stocks.value.map(async (s) => {
                            // 1. å¿«å–æ©Ÿåˆ¶ (1å°æ™‚)ï¼šè‹¥å·²æœ‰å¿«å–å‰‡ç›´æ¥è®€å–ï¼Œæ¸›å°‘ API æ¶ˆè€—
                            if (!force && apiCache[s.id] && (Date.now() - apiCache[s.id].timestamp < 3600000)) {
                                s.price = apiCache[s.id].price;
                                s.avgDividend = apiCache[s.id].avgDividend;
                                s.yearlyReturn = apiCache[s.id].yearlyReturn;
                                s.yieldRate = apiCache[s.id].yieldRate;
                                return;
                            }

                            // 2. æŠ“å–è‚¡åƒ¹ (æŠ“å–éå» 380 å¤©è³‡æ–™ä»¥ç¢ºä¿åŒ…å«ä¸€å¹´å‰çš„äº¤æ˜“æ—¥åŸºæº–)
                            const startDate = new Date(Date.now() - 380 * 86400000).toISOString().split('T')[0];
                            const pUrl = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockPrice&data_id=${s.id}&start_date=${startDate}`;
                            const pRes = await fetch(pUrl).then(r => r.json());
                            
                            let currentPrice = s.price;
                            let yearlyReturn = null;

                            if (pRes.data?.length > 0) {
                                const prices = pRes.data;
                                currentPrice = prices[prices.length - 1].close;
                                
                                // è¨ˆç®—è¿‘ä¸€å¹´æ¼²è·Œå¹…ï¼šå–å›æº¯ç´„ 241 å€‹äº¤æ˜“æ—¥çš„åƒ¹æ ¼ä½œç‚ºä¸€å¹´å‰åŸºæº–
                                const oldIndex = Math.max(0, prices.length - 241);
                                const oldPrice = prices[oldIndex].close;
                                
                                if (oldPrice > 0) {
                                    yearlyReturn = (((currentPrice - oldPrice) / oldPrice) * 100).toFixed(1);
                                }
                            }

                            // 3. æŠ“å–é…æ¯è³‡æ–™ (ç²¾æº–ç¯©é¸è¿‘ 12 å€‹æœˆå…§çš„é™¤æ¯ç´€éŒ„)
                            const dUrl = `https://api.finmindtrade.com/api/v4/data?dataset=TaiwanStockDividend&data_id=${s.id}&start_date=${oneYearAgo.toISOString().split('T')[0]}`;
                            const dRes = await fetch(dUrl).then(r => r.json());
                            
                            let totalDiv = 0;
                            if (dRes.data?.length > 0) {
                                dRes.data.forEach(item => {
                                    const cashDate = item.CashExDividendTradingDate ? new Date(item.CashExDividendTradingDate) : null;
                                    const stockDate = item.StockExDividendTradingDate ? new Date(item.StockExDividendTradingDate) : null;
                                    // åªçµ±è¨ˆéå»ä¸€å¹´å…§ç™¼ç”Ÿçš„é…æ¯
                                    if ((cashDate && cashDate >= oneYearAgo) || (stockDate && stockDate >= oneYearAgo)) {
                                        totalDiv += (item.CashEarningsDistribution || 0) + (item.StockEarningsDistribution || 0) + (item.StockStatutorySurplus || 0);
                                    }
                                });
                            }

                            // 4. è¨ˆç®—æ®–åˆ©ç‡ï¼š(è¿‘12å€‹æœˆç¸½é…æ¯ / ç›®å‰ç¾åƒ¹) * 100
                            let yieldRate = null;
                            if (totalDiv > 0 && currentPrice > 0) {
                                yieldRate = ((totalDiv / currentPrice) * 100).toFixed(1);
                            }

                            // 5. å°‡çµæœæ›´æ–°è‡³ Vue éŸ¿æ‡‰å¼ç‰©ä»¶
                            s.price = currentPrice;
                            s.avgDividend = totalDiv;
                            s.yearlyReturn = yearlyReturn;
                            s.yieldRate = yieldRate;
                            
                            // 6. å¯«å…¥å¿«å–
                            apiCache[s.id] = { 
                                price: currentPrice, 
                                avgDividend: totalDiv, 
                                yearlyReturn: yearlyReturn, 
                                yieldRate: yieldRate,
                                timestamp: Date.now() 
                            };
                        });
                        await Promise.all(tasks);
                    } catch (error) {
                        console.error("API æŠ“å–å¤±æ•—:", error);
                    } finally { 
                        loading.value = false; 
                    }
                };

                // --- åœ–è¡¨ç›¸é—œåŠŸèƒ½ ---
                const initChart = () => {
                    const ctx = document.getElementById('growthChart').getContext('2d');
                    if (chart) chart.destroy();
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: targetYears.value}, (_, i) => `${i+1}Y`),
                            datasets: [{ 
                                data: Array.from({length: targetYears.value}, (_, i) => calculateFutureValue(i+1)),
                                borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', 
                                fill: true, tension: 0.4, pointRadius: 2, pointBackgroundColor: '#3b82f6'
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { ticks: { font: { size: 10 }, callback: v => (v/10000).toFixed(0) + 'è¬' } },
                                x: { grid: { display: false } } 
                            }
                        }
                    });
                };

                const updateCharts = () => {
                    if (chart) {
                        chart.data.labels = Array.from({length: targetYears.value}, (_, i) => `${i+1}Y`);
                        chart.data.datasets[0].data = Array.from({length: targetYears.value}, (_, i) => calculateFutureValue(i+1));
                        chart.update();
                    }
                    // ç¢ºä¿ reportChartInstance åœ¨ generateReportImage æ™‚èƒ½è¢«æ­£ç¢ºå»ºç«‹å’Œæ›´æ–°
                };

                // --- åœ–ç‰‡å ±è¡¨ç”ŸæˆåŠŸèƒ½ ---
                const generateReportImage = async () => {
                    const reportElement = document.getElementById('report-template');
                    if (!reportElement) return;

                    // --- å¼·åˆ¶æ›´æ–°å ±è¡¨å…§çš„æ–‡å­— (è§£æ±º Vue èªæ³•æ²’è·‘å‡ºä¾†çš„å•é¡Œ) ---
                    document.getElementById('rep-current-val').innerText = `NT$ ${(currentInventoryValue.value/10000).toFixed(1)} è¬`;
                    document.getElementById('rep-monthly-val').innerText = `NT$ ${(totalMonthlyAmount.value/1000).toFixed(1)} K`;
                    document.getElementById('rep-target-label').innerText = `é ä¼° ${targetYears.value} å¹´å¾Œç¸½åƒ¹å€¼`;
                    document.getElementById('rep-future-val').innerText = `NT$ ${(calculateFutureValue(targetYears.value)/10000).toFixed(0)} è¬ ğŸ‰`;
                    document.getElementById('rep-time').innerText = new Date().toLocaleString();

                    // æ›´æ–°åœ–è¡¨ (ç¶­æŒåŸæ¨£)
                    const reportChartCtx = document.getElementById('reportChart').getContext('2d');
                    if (reportChartInstance) reportChartInstance.destroy();

                    reportChartInstance = new Chart(reportChartCtx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: targetYears.value}, (_, i) => `${i+1}Y`),
                            datasets: [{ 
                                data: Array.from({length: targetYears.value}, (_, i) => calculateFutureValue(i+1)),
                                borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', 
                                fill: true, tension: 0.4, pointRadius: 0
                            }]
                        },
                        options: {
                            responsive: false, // å ±è¡¨åœ–è¡¨å»ºè­°é—œé–‰éŸ¿æ‡‰å¼ï¼Œå›ºå®šå°ºå¯¸æˆªåœ–æ›´æº–
                            maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { ticks: { font: { size: 10 }, callback: v => (v/10000).toFixed(0) + 'è¬' } },
                                x: { grid: { display: false }, ticks: { font: { size: 9 } } } 
                            }
                        }
                    });

                    // çµ¦äºˆä¸€é»æ™‚é–“è®“åœ–è¡¨èˆ‡æ–‡å­—æ¸²æŸ“å®Œå…¨
                    await new Promise(resolve => setTimeout(resolve, 300)); 

                    html2canvas(reportElement, {
                        scale: 2,
                        logging: false,
                        backgroundColor: "#f8fafc"
                    }).then(canvas => {
                        const imgData = canvas.toDataURL('image/png');
                        
                        // --- åˆ¤æ–·æ˜¯å¦ç‚º iOS è£ç½® ---
                        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent) || 
                                    (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);

                        if (isIOS) {
                            // iOS: å¦é–‹è¦–çª—ï¼Œæ–¹ä¾¿ä½¿ç”¨è€…é•·æŒ‰å„²å­˜
                            const newWindow = window.open();
                            if (newWindow) {
                                newWindow.document.write(`
                                    <html>
                                        <head><title>æ‚¨çš„æŠ•è³‡å ±å‘Š (é•·æŒ‰åœ–ç‰‡å„²å­˜)</title></head>
                                        <body style="margin:0; display:flex; flex-direction:column; align-items:center; background:#f0f2f5; font-family:sans-serif;">
                                            <p style="margin-top:20px; color:#64748b; font-size:14px;">â†‘ é•·æŒ‰åœ–ç‰‡å³å¯å„²å­˜æˆ–åˆ†äº« â†‘</p>
                                            <img src="${imgData}" style="max-width:95%; height:auto; box-shadow:0 10px 25px rgba(0,0,0,0.1); border-radius:8px;" />
                                        </body>
                                    </html>
                                `);
                            } else {
                                alert("è«‹å…è¨±é–‹å•Ÿå½ˆå‡ºè¦–çª—ä»¥æŸ¥çœ‹å ±å‘Š");
                            }
                        } else {
                            // é iOS (Android/PC): ç¶­æŒåŸæœ¬çš„è‡ªå‹•ä¸‹è¼‰
                            const link = document.createElement('a');
                            const date = new Date().toISOString().slice(0, 10).replace(/-/g, '');
                            link.download = `å°è‚¡æŠ•è³‡è¦ç•«å ±å‘Š_${date}.png`;
                            link.href = imgData;
                            link.click();
                        }
                    });
                };

                // --- UI æµç¨‹æ§åˆ¶ ---
                const goToDashboard = async () => {
                    stocks.value = selectedIds.value.map(id => {
                        const meta = masterData[id] || masterData['default'];
                        return { id, holdings: 0, amount: 0, frequency: 1, rate: meta.rate, months: meta.months, price: null, avgDividend: 0 };
                    });
                    currentStep.value = 2;
                    await fetchPricesAndDividends(true);
                    await nextTick();
                    initChart();
                };

                const resetData = () => { 
                    if(confirm("ç¢ºå®šé‡ç½®ï¼Ÿé€™æœƒæ¸…é™¤æ‰€æœ‰è¨­å®šã€‚")) { 
                        localStorage.removeItem('tw_stock_v12_share_image'); 
                        location.reload(); 
                    } 
                };

                const getDividendStocks = (month) => {
                    const codes = [];
                    stocks.value.forEach(s => { 
                        if (((s.amount || 0) > 0 || (s.holdings || 0) > 0) && s.months.includes(month)) {
                            codes.push(s.id); 
                        }
                    });
                    return codes;
                };

                // --- ç›£è½èˆ‡æŒä¹…åŒ– ---
                watch([stocks, targetYears], () => {
                    if (currentStep.value === 2) {
                        localStorage.setItem('tw_stock_v12_share_image', JSON.stringify({
                            step: 2, selectedIds: selectedIds.value, stocks: stocks.value, targetYears: targetYears.value
                        }));
                        updateCharts(); // æ›´æ–°å…©å€‹åœ–è¡¨
                        if (debounceTimer) clearTimeout(debounceTimer);
                        debounceTimer = setTimeout(() => fetchPricesAndDividends(), 1500);
                    }
                }, { deep: true });

                onMounted(() => {
                    const saved = localStorage.getItem('tw_stock_v12_share_image');

                    if (saved) {
                        const p = JSON.parse(saved);
                        selectedIds.value = p.selectedIds || [];
                        stocks.value = p.stocks || [];
                        targetYears.value = p.targetYears || 20;
                        currentStep.value = p.step || 1;
                        
                        if (currentStep.value === 2) {
                            setTimeout(() => { 
                                fetchPricesAndDividends(true); 
                                initChart(); 
                            }, 200);
                        }
                    }
                });

                return { 
                    currentStep, sortedHotList, selectedIds, sortedSelectedIds, sortedStocks, 
                    customInput, stocks, loading, targetYears, currentInventoryValue, 
                    totalMonthlyAmount, toggleStock, addCustomStock, goToDashboard, 
                    calculateFutureValue, getDividendStocks, getMonthlyDividendAmount, 
                    resetData, generateReportImage, currentDateTime 
                };
            }
        }).mount('#app');
    </script>
</body>
</html>
