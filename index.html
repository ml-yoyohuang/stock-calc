<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>台股投資規畫工具 - 專業配息精準版</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body class="bg-slate-50 min-h-screen">
    <div id="app" class="max-w-7xl mx-auto px-4 py-12">

        <div v-if="currentStep === 1" class="max-w-2xl mx-auto bg-white rounded-3xl shadow-xl p-8 border border-slate-200">
            <div class="text-center mb-8">
                <h1 class="text-3xl font-black text-slate-800 tracking-tight">開始投資規畫</h1>
                <p class="text-slate-500 mt-2">請選取或輸入想試算的股票代號</p>
            </div>
            <div class="space-y-6">
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-3">熱門推薦</label>
                    <div class="flex flex-wrap gap-2">
                        <button v-for="id in hotList" :key="id" @click="toggleStock(id)"
                                :class="['px-4 py-2 rounded-xl border-2 font-bold transition-all', 
                                selectedIds.includes(id) ? 'bg-blue-600 border-blue-600 text-white shadow-lg' : 'bg-white border-slate-100 text-slate-500']">
                            {{ id }}
                        </button>
                    </div>
                </div>
                <div>
                    <input type="text" v-model="customInput" placeholder="例如: 00713" @keyup.enter="addCustomStock"
                           class="w-full border-2 border-slate-100 rounded-xl px-4 py-2 mb-4 outline-none focus:border-blue-500">
                    <button @click="goToDashboard" :disabled="selectedIds.length === 0"
                            class="w-full py-4 rounded-2xl font-black text-lg bg-blue-600 text-white hover:bg-blue-700 disabled:bg-slate-200 shadow-xl transition-all">
                        下一步：進入試算儀表板
                    </button>
                </div>
            </div>
        </div>

        <div v-if="currentStep === 2">
            <div class="flex flex-col md:flex-row md:items-center justify-between mb-8 gap-4">
                <div class="flex items-center gap-4">
                    <button @click="currentStep = 1" class="bg-white border border-slate-200 p-2 rounded-xl hover:bg-slate-50 shadow-sm">⬅ 返回</button>
                    <div>
                        <h1 class="text-3xl font-black text-slate-800">試算儀表板</h1>
                        <p class="text-slate-500 text-sm">已啟用快取與防抖機制，保護 API 額度</p>
                    </div>
                </div>
                <div class="flex items-center gap-2">
                    <span v-if="loading" class="text-xs bg-amber-100 text-amber-600 px-3 py-1 rounded-full animate-pulse font-bold">同步中...</span>
                    <button @click="resetData" class="text-xs text-slate-400 hover:text-red-500 underline">重置</button>
                </div>
            </div>

            <div class="grid grid-cols-12 gap-6">
                <div class="col-span-12 xl:col-span-8">
                    <div class="bg-white rounded-2xl shadow-sm border border-slate-200 overflow-auto text-sm">
                        <table class="w-full text-left border-collapse min-w-[600px]">
                            <thead>
                                <tr class="bg-slate-800 text-white text-[10px] uppercase tracking-wider">
                                    <th class="p-4">標的/現價</th>
                                    <th class="p-4 text-center">庫存(張)</th>
                                    <th class="p-4 text-center">每月扣款(千)</th>
                                    <th class="p-4 text-center">每月次數</th>
                                    <th class="p-4 text-center">預估報酬 %</th>
                                    <th class="p-4 text-right">月投小計</th>
                                </tr>
                            </thead>
                            <tbody class="divide-y divide-slate-100">
                                <tr v-for="stock in stocks" :key="stock.id" class="hover:bg-slate-50">
                                    <td class="p-4">
                                        <div class="font-bold text-slate-700">{{ stock.id }}</div>
                                        <div class="text-[11px] text-blue-500 font-mono">{{ stock.price ? `$${stock.price}` : '...' }}</div>
                                    </td>
                                    <td class="p-4 text-center"><input type="number" v-model.number="stock.holdings" class="w-16 border rounded text-center py-1 bg-blue-50/50 outline-none"></td>
                                    <td class="p-4 text-center"><input type="number" v-model.number="stock.amount" class="w-14 border rounded text-center py-1 outline-none"></td>
                                    <td class="p-4 text-center"><input type="number" v-model.number="stock.frequency" class="w-10 border rounded text-center py-1 outline-none"></td>
                                    <td class="p-4 text-center"><input type="number" v-model.number="stock.rate" step="0.5" class="w-12 text-center text-emerald-600 font-bold bg-transparent">%</td>
                                    <td class="p-4 text-right font-mono font-bold text-slate-600 italic">{{ (stock.amount * stock.frequency).toLocaleString() }}k</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="col-span-12 xl:col-span-4 space-y-6">
                    <div class="bg-slate-800 p-6 rounded-3xl text-white shadow-xl">
                        <div class="flex justify-between items-center mb-4">
                            <p class="text-slate-400 text-[10px] font-bold uppercase tracking-widest">預估 {{ targetYears }} 年後總價值</p>
                            <span class="text-[10px] bg-blue-600 px-2 py-1 rounded font-bold">{{ targetYears }}Y</span>
                        </div>
                        <h2 class="text-4xl font-black tracking-tight text-blue-400 mb-6">
                            NT$ {{ (calculateFutureValue(targetYears)/10000).toFixed(0) }} <span class="text-lg text-white">萬</span>
                        </h2>
                        <div class="grid grid-cols-2 gap-4 mb-6 pt-6 border-t border-slate-700">
                            <div>
                                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">目前庫存市值</p>
                                <p class="text-lg font-bold text-white">{{ (currentInventoryValue/10000).toFixed(1) }} <span class="text-xs">萬</span></p>
                            </div>
                            <div>
                                <p class="text-slate-400 text-[10px] font-bold uppercase tracking-wider mb-1">月投入總額</p>
                                <p class="text-lg font-bold text-white">{{ (totalMonthlyAmount/1000).toFixed(1) }} <span class="text-xs">K</span></p>
                            </div>
                        </div>
                        <input type="range" v-model.number="targetYears" min="1" max="40" class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer accent-blue-500">
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-wider">資產增長曲線 ({{ targetYears }}年)</h3>
                        <div class="h-[250px]"><canvas id="growthChart"></canvas></div>
                    </div>

                    <div class="bg-white p-6 rounded-2xl border border-slate-200 shadow-sm">
                        <h3 class="text-xs font-bold text-slate-500 mb-4 uppercase tracking-wider">年度預計領息月份 (近1年)</h3>
                        <div class="grid grid-cols-3 gap-3">
                            <div v-for="m in 12" :key="m" 
                                 :class="['p-3 rounded-xl border transition-all min-h-[85px]', 
                                 getDividendStocks(m).length > 0 ? 'bg-emerald-50 border-emerald-200' : 'bg-slate-50 opacity-40']">
                                <div class="text-[10px] font-black text-slate-400 mb-1 border-b pb-1 flex justify-between items-center">
                                    <span>{{ m }}月</span>
                                    <span v-if="getMonthlyDividendAmount(m) > 0" class="text-emerald-700 font-bold bg-emerald-200/50 px-1 rounded">
                                        ${{ getMonthlyDividendAmount(m).toLocaleString() }}
                                    </span>
                                </div>
                                <div class="flex flex-wrap gap-1 mt-1">
                                    <span v-for="code in getDividendStocks(m)" :key="code" class="text-[9px] font-bold bg-emerald-600 text-white px-1 rounded">
                                        {{ code }}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp, ref, computed, onMounted, watch, nextTick } = Vue;

        // 全域快取，避免重複請求
        const apiCache = {}; 

        createApp({
            setup() {
                const currentStep = ref(1);
                const hotList = ['0050', '0056', '00878', '006208', '2330'];
                const selectedIds = ref([]);
                const customInput = ref("");
                const stocks = ref([]);
                const loading = ref(false);
                const targetYears = ref(20);
                let chart = null;
                let debounceTimer = null;

                const masterData = {
                    '0050': { months: [1, 7], rate: 8.5 },
                    '0056': { months: [1, 4, 7, 10], rate: 6.5 },
                    '00878': { months: [2, 5, 8, 11], rate: 6.0 },
                    '006208': { months: [1, 7], rate: 8.5 },
                    '2330': { months: [3, 6, 9, 12], rate: 12.0 },
                    'default': { months: [1, 4, 7, 10], rate: 7.0 }
                };

                // --- 運算邏輯 (forEach 版) ---
                const currentInventoryValue = computed(() => {
                    let total = 0;
                    stocks.value.forEach(s => { total += (s.holdings || 0) * 1000 * (s.price || 0); });
                    return total;
                });

                const totalMonthlyAmount = computed(() => {
                    let total = 0;
                    stocks.value.forEach(s => { total += (s.amount || 0) * (s.frequency || 0) * 1000; });
                    return total;
                });

                const calculateFutureValue = (years) => {
                    let grandTotal = 0;
                    stocks.value.forEach(s => {
                        const startVal = (s.holdings || 0) * 1000 * (s.price || 0);
                        const r_annual = (s.rate || 0) / 100;
                        const futureInventory = startVal * Math.pow(1 + r_annual, years);
                        const p = (s.amount || 0) * (s.frequency || 0) * 1000;
                        let futureSIP = 0;
                        if (p > 0) {
                            const r_monthly = r_annual / 12;
                            const n_months = years * 12;
                            futureSIP = p * (Math.pow(1 + r_monthly, n_months) - 1) / r_monthly;
                        }
                        grandTotal += (futureInventory + futureSIP);
                    });
                    return Math.round(grandTotal);
                };

                const getMonthlyDividendAmount = (month) => {
                    let total = 0;
                    stocks.value.forEach(s => {
                        if (s.months.includes(month) && s.avgDividend > 0) {
                            const divPerTime = s.avgDividend / s.months.length;
                            const fromHoldings = (s.holdings || 0) * 1000 * divPerTime;
                            const monthlyShares = ((s.amount || 0) * 1000) / (s.price || 150);
                            const fromSIP = (monthlyShares * 6) * divPerTime; // 粗估半年平均持有量
                            total += (fromHoldings + fromSIP);
                        }
                    });
                    return Math.round(total);
                };

                // --- 核心優化：配息計算與 API 快取 ---
                const fetchPricesAndDividends = async (force = false) => {
                    if (loading.value && !force) return;
                    loading.value = true;
                    try {
                        const now = new Date();
                        const oneYearAgo = new Date();
                        oneYearAgo.setFullYear(now.getFullYear() - 1); // 取得 12 個月前的時間點

                        const tasks = stocks.value.map(async (s) => {
                            // 檢查快取 (1小時內有效)
                            if (!force && apiCache[s.id] && (Date.now() - apiCache[s.id].timestamp < 3600000)) {
                                s.price = apiCache[s.id].price;
                                s.avgDividend = apiCache[s.id].avgDividend;
                                return;
                            }

                            // 1. 抓股價
                            const pParam = new URLSearchParams({ dataset: "TaiwanStockPrice", data_id: s.id, start_date: new Date(Date.now() - 864000000).toISOString().split('T')[0] });
                            const pRes = await fetch(`https://api.finmindtrade.com/api/v4/data?${pParam}`).then(r => r.json());
                            const currentPrice = pRes.data?.length > 0 ? pRes.data[pRes.data.length - 1].close : s.price;

                            // 2. 抓配息 (過去兩年資料以確保能篩選出最近12個月)
                            const dParam = new URLSearchParams({ dataset: "TaiwanStockDividend", data_id: s.id, start_date: new Date(Date.now() - 63072000000).toISOString().split('T')[0] });
                            const dRes = await fetch(`https://api.finmindtrade.com/api/v4/data?${dParam}`).then(r => r.json());

                            let totalDiv = 0;
                            if (dRes.data?.length > 0) {
                                dRes.data.forEach(item => {
                                    // 判斷除息日或除權日是否在 12 個月內
                                    const cashDate = item.CashExDividendTradingDate ? new Date(item.CashExDividendTradingDate) : null;
                                    const stockDate = item.StockExDividendTradingDate ? new Date(item.StockExDividendTradingDate) : null;
                                    
                                    const isRecentCash = cashDate && cashDate >= oneYearAgo;
                                    const isRecentStock = stockDate && stockDate >= oneYearAgo;

                                    if (isRecentCash || isRecentStock) {
                                        const cashVal = item.CashEarningsDistribution || 0;
                                        const stockVal = (item.StockEarningsDistribution || 0) + (item.StockStatutorySurplus || 0);
                                        totalDiv += (cashVal + stockVal);
                                    }
                                });
                            }

                            // 更新資料與快取
                            s.price = currentPrice;
                            s.avgDividend = totalDiv;
                            apiCache[s.id] = { price: currentPrice, avgDividend: totalDiv, timestamp: Date.now() };
                        });
                        await Promise.all(tasks);
                    } catch (e) {
                        console.error("API Error:", e);
                    } finally {
                        loading.value = false;
                    }
                };

                // --- 防抖觸發機制 ---
                const debouncedFetch = () => {
                    if (debounceTimer) clearTimeout(debounceTimer);
                    debounceTimer = setTimeout(() => {
                        fetchPricesAndDividends();
                    }, 1000); // 停止輸入 1 秒後才執行
                };

                const initChart = () => {
                    const ctx = document.getElementById('growthChart').getContext('2d');
                    if (chart) chart.destroy();
                    chart = new Chart(ctx, {
                        type: 'line',
                        data: {
                            labels: Array.from({length: targetYears.value}, (_, i) => `${i+1}Y`),
                            datasets: [{ 
                                data: Array.from({length: targetYears.value}, (_, i) => calculateFutureValue(i+1)),
                                borderColor: '#3b82f6', backgroundColor: 'rgba(59, 130, 246, 0.1)', 
                                fill: true, tension: 0.4, pointRadius: 2, pointBackgroundColor: '#3b82f6'
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false } },
                            scales: { 
                                y: { ticks: { font: { size: 10 }, callback: v => (v/10000).toFixed(0) + '萬' } },
                                x: { grid: { display: false }, ticks: { font: { size: 9 } } } 
                            }
                        }
                    });
                };

                const updateChart = () => {
                    if (chart) {
                        chart.data.labels = Array.from({length: targetYears.value}, (_, i) => `${i+1}Y`);
                        const newData = [];
                        for(let i=1; i<=targetYears.value; i++) { newData.push(calculateFutureValue(i)); }
                        chart.data.datasets[0].data = newData;
                        chart.update();
                    }
                };

                const goToDashboard = async () => {
                    stocks.value = selectedIds.value.map(id => {
                        const meta = masterData[id] || masterData['default'];
                        return { id, holdings: 0, amount: 0, frequency: 1, rate: meta.rate, months: meta.months, price: null, avgDividend: 0 };
                    });
                    currentStep.value = 2;
                    await fetchPricesAndDividends(true);
                    await nextTick();
                    initChart();
                };

                watch([stocks, targetYears], () => {
                    if (currentStep.value === 2) {
                        localStorage.setItem('tw_stock_pro_v10', JSON.stringify({
                            step: 2, selectedIds: selectedIds.value, stocks: stocks.value, targetYears: targetYears.value
                        }));
                        updateChart();
                        debouncedFetch(); // 使用防抖更新 API 資料
                    }
                }, { deep: true });

                const toggleStock = (id) => {
                    const idx = selectedIds.value.indexOf(id);
                    if (idx > -1) selectedIds.value.splice(idx, 1);
                    else selectedIds.value.push(id);
                };
                const addCustomStock = () => {
                    if (customInput.value && !selectedIds.value.includes(customInput.value)) {
                        selectedIds.value.push(customInput.value.trim());
                        customInput.value = "";
                    }
                };
                const getDividendStocks = (month) => {
                    const codes = [];
                    stocks.value.forEach(s => { if (((s.amount || 0) > 0 || (s.holdings || 0) > 0) && s.months.includes(month)) codes.push(s.id); });
                    return codes;
                };
                const resetData = () => { if(confirm("確定重置？")) { localStorage.removeItem('tw_stock_pro_v10'); location.reload(); } };

                onMounted(() => {
                    const saved = localStorage.getItem('tw_stock_pro_v10');
                    if (saved) {
                        const p = JSON.parse(saved);
                        selectedIds.value = p.selectedIds; stocks.value = p.stocks; targetYears.value = p.targetYears || 20;
                        currentStep.value = 2;
                        setTimeout(() => { fetchPricesAndDividends(true); initChart(); }, 100);
                    }
                });

                return { currentStep, hotList, selectedIds, customInput, stocks, loading, targetYears, currentInventoryValue, totalMonthlyAmount, toggleStock, addCustomStock, goToDashboard, calculateFutureValue, getDividendStocks, getMonthlyDividendAmount, resetData };
            }
        }).mount('#app');
    </script>
</body>
</html>
